<!-- Code from d3-graph-gallery.com -->
<!DOCTYPE html>
<head>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>
<!-- Create a div where the graph will take place -->
<style>
  td, th {
    padding: 1px 4px;
  }
  </style>
</head>
<body>
<h1>Advantage and Disadvantage</h1>
<table id="advantage" class="table table-sm table-striped table-hover sortable"></table>
<h1>Type of Roll</h1>
<table id="type_of_roll" class="table table-sm table-striped table-hover sortable"></table>
<h1>The Extremes</h1>
<table id="crits" class="table table-sm table-striped table-hover sortable"></table>
<h1>D20 Average Rolls</h1>
<table id="d20_performance_by_type" class="table table-sm table-striped table-hover sortable"></table>
<h1>D20s Save the Day!</h1>
<table id="save_specific_data" class="table table-sm table-striped table-hover sortable"></table>
<h1>Ability Checks</h1>
<table id="ability_specific_data" class="table table-sm table-striped table-hover sortable"></table>
<h1>Skill Checks</h1>
<table id="skill_specific_data" class="table table-sm table-striped table-hover sortable"></table>

<script>
const getCellValue = (tr, idx) => {
  let v = tr.children[idx].innerText || tr.children[idx].textContent
  if (v.slice(-1) === '%') {
    return parseFloat(v.slice(0, -1));
  }
  return v;
};

const comparer = (idx, asc) => (a, b) => ((v1, v2) => 
    v1 !== '' && v2 !== '' && !isNaN(v1) && !isNaN(v2) ? v1 - v2 : v1.toString().localeCompare(v2)
    )(getCellValue(asc ? a : b, idx), getCellValue(asc ? b : a, idx));

  function tabulate(id, data, columns, column_name_map, column_pct_map, column_roll_fmt_map) {
		const table = d3.select(id)
		const thead = table.append('thead')
		const	tbody = table.append('tbody');

		// append the header row
		thead.append('tr')
		  .selectAll('th')
		  .data(columns).enter()
		  .append('th')
		    .text(function (column) { if (column_name_map[column] === undefined) {return column} else {return column_name_map[column]} });

		// create a row for each object in the data
		const rows = tbody.selectAll('tr')
		  .data(data)
		  .enter()
		  .append('tr');
    const formatter = new Intl.NumberFormat('en-US', {
      minimumFractionDigits: 1,      
      maximumFractionDigits: 1,
    });
		// create a cell in each row for each column
		const cells = rows.selectAll('td')
		  .data(function (row) {
		    return columns.map(function (column) {
          if (column_pct_map[column] !== undefined && column_pct_map[column] === true) {
            return {column: column, value: formatter.format(row[column] * 100) + '%'}
          } else if (column_roll_fmt_map[column] !== undefined && column_roll_fmt_map[column] === true) {
            return {column: column, value: formatter.format(row[column])}
          } else {
		        return {column: column, value: row[column]}
          };
		    });
		  })
		  .enter()
		  .append('td')
		    .text(function (d) { return d.value; });

	  return table;
	}

d3.json('d20_data.json', (error, data) => {
  const column_name_map = {
    'player': 'Player',
    'roll_count': 'D20 Rolls',
    'advantage_count': 'Rolls with Advantage',
    'disadvantage_count': 'Rolls with Disadvantage',
    'advantage_ratio': '% Advantage',
    'disadvantage_ratio': '% Disadvantage',
    'attack_roll_count': 'Attacks',
    'attack_roll_ratio': '% Attacks',
    'saving_throw_count': 'Saves',
    'saving_throw_ratio': '% Saves',
    'ability_check_count': 'Ability Checks',
    'ability_check_ratio': '% Ability Checks',
    'skill_check_count': 'Skill Checks',
    'skill_check_ratio': '% Skill Checks',
    'nat_20_count': 'Nat 20s',
    'nat_20_ratio': '% Nat 20s',
    'nat_1_count': 'Nat 1s',
    'nat_1_ratio': '% Nat 1s',
    'stolen_nat_20_count': 'Stolen Nat 20s', 
    'super_nat_20_count': 'Super Nat 20s',
    'disadvantage_nat_20_count': 'Disadvantage Nat 20s',
    'dropped_nat_1_count': 'Dropped Nat 1s',
    'super_nat_1_count': 'Super Nat 1s',
    'advantage_nat_1_count': 'Advantage Nat 1s',
    'average_raw_d20_roll': "Raw D20 (inc. dropped)",
    'average_final_d20_roll': "Raw D20 (after adv./disadv.)",
    'average_d20_after_modifiers': "D20 after Mods",
    'average_attack_before_modifiers': "Attacks before Mods",
    'average_save_before_modifiers': "Saves before Mods",
    'average_skill_before_modifiers': "Skill Checks before Mods",
    'average_ability_before_modifiers': "Ability Checks before Mods",
    'average_attack_after_modifiers': "Attacks after Mods",
    'average_save_after_modifiers': "Saves after Mods",
    'average_skill_after_modifiers': "Skill Checks after Mods",
    'average_ability_after_modifiers': "Ability Checks after Mods",
    'str_save_count': 'STR Count',
    'dex_save_count': 'DEX Count',
    'con_save_count': 'CON Count',
    'int_save_count': 'INT Count',
    'wis_save_count': 'WIS Count',
    'cha_save_count': 'CHA Count',
    'death_save_count': 'Death Count',
    'str_ability_check_count': 'STR Count',
    'dex_ability_check_count': 'DEX Count',
    'con_ability_check_count': 'CON Count',
    'int_ability_check_count': 'INT Count',
    'wis_ability_check_count': 'WIS Count',
    'cha_ability_check_count': 'CHA Count',
    'acr_skill_count': 'Acrobatics Count',
    'ani_skill_count':'Animal Handling Count',
    'arc_skill_count':'Arcana Count',
    'ath_skill_count':'Athletics Count',
    'dec_skill_count':'Deception Count',
    'his_skill_count':'History Count',
    'ins_skill_count':'Insight Count',
    'itm_skill_count':'Intimidation Count',
    'inv_skill_count':'Investigation Count',
    'med_skill_count':'Medicine Count',
    'nat_skill_count':'Nature Count',
    'prc_skill_count':'Perception Count',
    'prf_skill_count':'Performance Count',
    'per_skill_count':'Persuasion Count',
    'rel_skill_count':'Religion Count',
    'slt_skill_count':'Sleight of Hand Count',
    'ste_skill_count':'Stealth Count',
    'sur_skill_count':'Survival Count',
  }
  const column_pct_map = {
    'advantage_ratio': true,
    'disadvantage_ratio': true,
    'attack_roll_ratio': true,
    'saving_throw_ratio': true,
    'ability_check_ratio': true,
    'skill_check_ratio': true,
    'nat_20_ratio': true,
    'nat_1_ratio': true,
  }
  const column_roll_fmt_map = {
    'average_raw_d20_roll': true,
    'average_final_d20_roll': true,
    'average_d20_after_modifiers': true,
    'average_attack_before_modifiers': true,
    'average_save_before_modifiers': true,
    'average_skill_before_modifiers': true,
    'average_ability_before_modifiers': true,
    'average_attack_after_modifiers': true,
    'average_save_after_modifiers': true,
    'average_skill_after_modifiers': true,
    'average_ability_after_modifiers': true,
  }
  tabulate('#advantage', data, ['player', 'roll_count', 'advantage_count', 'advantage_ratio', 'disadvantage_count', 'disadvantage_ratio'], column_name_map, column_pct_map, column_roll_fmt_map);
  tabulate('#type_of_roll', data, ['player', 'roll_count', 'attack_roll_count', 'attack_roll_ratio', 'saving_throw_count', 'saving_throw_ratio', 'ability_check_count', 'ability_check_ratio', 'skill_check_count', 'skill_check_ratio'], column_name_map, column_pct_map, column_roll_fmt_map);
  tabulate('#crits', data, ['player', 'roll_count', 'nat_20_count', 'nat_20_ratio', 'nat_1_count', 'nat_1_ratio', 'stolen_nat_20_count', 'super_nat_20_count', 'disadvantage_nat_20_count', 'dropped_nat_1_count', 'super_nat_1_count', 'advantage_nat_1_count'], column_name_map, column_pct_map, column_roll_fmt_map);
  tabulate('#d20_performance_by_type', data, ['player', 'roll_count', 'average_raw_d20_roll', 'average_final_d20_roll', 'average_d20_after_modifiers', 'average_attack_before_modifiers', 'average_attack_after_modifiers', 'average_save_before_modifiers', 'average_save_after_modifiers', 'average_skill_before_modifiers', 'average_skill_after_modifiers', 'average_ability_before_modifiers', 'average_ability_after_modifiers'], column_name_map, column_pct_map, column_roll_fmt_map);
  tabulate('#save_specific_data', data, ['player', 'saving_throw_count', 'str_save_count', 'dex_save_count', 'con_save_count', 'int_save_count', 'wis_save_count', 'cha_save_count', 'death_save_count'], column_name_map, column_pct_map, column_roll_fmt_map);
  tabulate('#ability_specific_data', data, ['player', 'ability_check_count', 'str_ability_check_count', 'dex_ability_check_count', 'con_ability_check_count', 'int_ability_check_count', 'wis_ability_check_count', 'cha_ability_check_count'], column_name_map, column_pct_map, column_roll_fmt_map);
  tabulate('#skill_specific_data', data, ['player', 'skill_check_count', 'acr_skill_count', 'ani_skill_count', 'arc_skill_count', 'ath_skill_count', 'dec_skill_count', 'his_skill_count', 'ins_skill_count', 'itm_skill_count', 'inv_skill_count', 'med_skill_count', 'nat_skill_count', 'prc_skill_count', 'prf_skill_count', 'per_skill_count', 'rel_skill_count', 'slt_skill_count', 'ste_skill_count', 'sur_skill_count'], column_name_map, column_pct_map, column_roll_fmt_map)

  document.querySelectorAll('th').forEach(th => th.addEventListener('click', (() => {
    const table = th.closest('table');
    const tbody = table.querySelector('tbody')
    Array.from(tbody.querySelectorAll('tr'))
        .sort(comparer(Array.from(th.parentNode.children).indexOf(th), this.asc = !this.asc))
        .forEach(tr => tbody.appendChild(tr) );
})));
});

</script>
</body>